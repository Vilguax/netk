FROM node:20-alpine AS base
WORKDIR /app

FROM base AS deps
COPY package.json package-lock.json ./
COPY apps ./apps
COPY packages ./packages
COPY tsconfig.json tsconfig.base.json turbo.json ./
RUN npm install

FROM deps AS builder
ARG APP_DIR
RUN test -n "$APP_DIR"
RUN sh -c "cd \"$APP_DIR\" && npx next build"

FROM base AS runner
ENV NODE_ENV=production
COPY --from=builder /app /app
RUN npm prune --omit=dev
ARG APP_DIR
ARG APP_PORT
ENV APP_DIR=$APP_DIR
ENV PORT=$APP_PORT
EXPOSE 3000
CMD ["sh", "-c", "cd \"$APP_DIR\" && npx next start -p \"$PORT\""]
